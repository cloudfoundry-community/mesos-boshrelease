#!/usr/bin/env bash

#
# Apache Mesos Slave properties
#

# Directory to store the Apache Mesos Slave configuration files
export MESOS_AGENT_CONF_DIR=${JOB_DIR}/config

# Directory to store the Apache Mesos Slave log files
export MESOS_AGENT_LOG_DIR=${LOG_DIR}

# Directory to store the Apache Mesos Slave process IDs
export MESOS_AGENT_PID_DIR=${RUN_DIR}

# Directory to store the Apache Mesos Slave data files
export MESOS_AGENT_STORE_DIR=${STORE_DIR}

# Directory to store the Apache Mesos Slave temp files
export MESOS_AGENT_TMP_DIR=${TMP_DIR}

# User which will own the Apache Mesos Slave services
export MESOS_AGENT_USER="<%= p('mesos.agent.user') %>"

# Group which will own the Apache Mesos Slave services
export MESOS_AGENT_GROUP="<%= p('mesos.agent.group') %>"

# Apache Mesos Home directory
export MESOS_HOME=/var/vcap/packages/mesos

# Attributes of machine
export MESOS_AGENT_ATTRIBUTES="<%= p('mesos.agent.attributes') %>"

# Authenticatee implementation to use when authenticating against the master
export MESOS_AGENT_AUTHENTICATEE="<%= p('mesos.agent.authenticatee') %>"

# Cgroups feature flag to enable hard limits on CPU resources via the CFS bandwidth limiting subfeature
export MESOS_AGENT_CGROUPS_ENABLE_CFS="<%= p('mesos.agent.cgroups_enable_cfs') %>"

# The path to the cgroups hierarchy root
export MESOS_AGENT_CGROUPS_HIERARCHY="<%= p('mesos.agent.cgroups_hierarchy') %>"

# Cgroups feature flag to enable memory limits on both memory and swap instead of just memory
export MESOS_AGENT_CGROUPS_LIMIT_SWAP="<%= p('mesos.agent.cgroups_limit_swap') %>"

# Name of the root cgroup
export MESOS_AGENT_CGROUPS_ROOT="<%= p('mesos.agent.cgroups_root') %>"

# The interval between disk quota checks for containers
export MESOS_AGENT_CONTAINER_DISK_WATCH_INTERVAL="<%= p('mesos.agent.container_disk_watch_interval') %>"

<% if_p('mesos.principal', 'mesos.secret') do |principal, secret| %>
# File containing the list of credentials
export MESOS_AGENT_CREDENTIALS="--credential=file://${MESOS_AGENT_CONF_DIR}/credentials"
<% end %>

# Default role
export MESOS_AGENT_DEFAULT_ROLE="<%= p('mesos.agent.default_role') %>"

# Periodic time interval (e.g., 10secs, 2mins, etc) to check the disk usage
export MESOS_AGENT_DISK_WATCH_INTERVAL="<%= p('mesos.agent.disk_watch_interval') %>"

# The amount of time to wait before removing docker containers
export MESOS_AGENT_DOCKER_REMOVE_DELAY="<%= p('mesos.agent.docker.remove_delay') %>"

# The absolute path for the directory in the container where the sandbox is mapped to
export MESOS_AGENT_DOCKER_SANDBOX_DIRECTORY="<%= p('mesos.agent.docker.sandbox_directory') %>"

# The time as a duration for docker to wait after stopping an instance before it kills that instance
export MESOS_AGENT_DOCKER_STOP_TIMEOUT="<%= p('mesos.agent.docker.stop_timeout') %>"

# Whether to enable disk quota enforcement for containers
export MESOS_AGENT_ENFORCE_CONTAINER_DISK_QUOTA="<%= p('mesos.agent.enforce_container_disk_quota') %>"

# Amount of time to wait for an executor to register with the agent before considering it hung and shutting it down
export MESOS_AGENT_EXECUTOR_REGISTRATION_TIMEOUT="<%= p('mesos.agent.executor_registration_timeout') %>"

# Amount of time to wait for an executor to shut down
export MESOS_AGENT_EXECUTOR_SHUTDOWN_GRACE_PERIOD="<%= p('mesos.agent.executor_shutdown_grace_period') %>"

# Maximum amount of time to wait before cleaning up executor directories
export MESOS_AGENT_GC_DELAY="<%= p('mesos.agent.gc_delay') %>"

# Adjust disk headroom used to calculate maximum executor directory age
export MESOS_AGENT_GC_DISK_HEADROOM="<%= p('mesos.agent.gc_disk_headroom') %>"

# Whether to automatically initialize google logging of scheduler and/or executor drivers
export MESOS_AGENT_INITIALIZE_DRIVER_LOGGING="<%= p('mesos.agent.initialize_driver_logging') %>"

# Apache Mesos Slave isolation mechanism (process, cgroups)
export MESOS_AGENT_ISOLATION="<%= p('mesos.agent.isolation') %>"

# How many seconds to buffer log messages for
export MESOS_AGENT_LOGBUFSECS="<%= p('mesos.agent.logbufsecs') %>"

# Log message at or above this level
export MESOS_AGENT_LOGLEVEL="<%= p('mesos.agent.loglevel') %>"

# Duration of a perf stat sample
export MESOS_AGENT_PERF_DURATION="<%= p('mesos.agent.perf_duration') %>"

# List of command-separated perf events to sample for each container when using the perf_event isolator
export MESOS_AGENT_PERF_EVENTS="<%= p('mesos.agent.perf_events') %>"

# Interval between the start of perf stat samples
export MESOS_AGENT_PERF_INTERVAL="<%= p('mesos.agent.perf_interval') %>"

# Port where Apache Mesos Slave will listen on
export MESOS_AGENT_PORT="<%= p('mesos.agent.port') %>"

# Whether to recover Apache Mesos Slaves status updates and reconnect with old executors (reconnect, cleanup)
export MESOS_AGENT_RECOVER="<%= p('mesos.agent.recover') %>"

# Amount of time alloted for the Apache Mesos Slaves to recover
export MESOS_AGENT_RECOVERY_TIMEOUT="<%= p('mesos.agent.recovery_timeout') %>"

# Registration backoff factor
export MESOS_AGENT_REGISTRATION_BACKOFF_FACTOR="<%= p('mesos.agent.registration_backoff_factor') %>"

# Periodic time interval for monitoring executor resource usage
export MESOS_AGENT_RESOURCE_MONITORING_INTERVAL="<%= p('mesos.agent.resource_monitoring_interval') %>"

# Total consumable resources per agent, in the form 'name(role):value;name(role):value...'
export MESOS_AGENT_RESOURCES="<%= p('mesos.agent.resources') %>"

# List of comma-separated cgroup subsystems to run the agent binary
export MESOS_AGENT_SUBSYSTEMS="<%= p('mesos.agent.subsystems') %>"

# Whether to do Apache Mesos Slaves recovery in strict mode
export MESOS_AGENT_STRICT="<%= p('mesos.agent.strict') %>"

# Whether to run tasks as the user who submitted them rather than the user running the agent
export MESOS_AGENT_SWITCH_USER="<%= p('mesos.agent.switch_user') %>"

# SASL plugins
export SASL_PATH=/var/vcap/packages/sasl/lib/sasl2/

# Docker UNIX socket
export DOCKER_HOST=unix:///var/vcap/sys/run/docker/docker.sock

